<main class="page">
  <header class="hero">
    <div class="hero__text">
      <h1>{{ t("title") }}</h1>
      <p>{{ t("subtitle") }}</p>
    </div>
    <div class="hero__stats">
      <div class="pill">
        <span class="pill__label">{{ t("booksTitle") }}</span>
        <span class="pill__value">{{ books.length }}</span>
      </div>
      <div class="pill">
        <span class="pill__label">{{ t("borrowStatus") }}</span>
        <span class="pill__value"
          >{{ booksOnLoanCount }} / {{ books.length }}</span
        >
      </div>
      <div class="pill">
        <span class="pill__label">{{ t("queue") }}</span>
        <span class="pill__value">{{ queuedCount }}</span>
      </div>
    </div>
  </header>

  <section class="card action-card">
    <div class="card__header">
      <div>
        <p class="eyebrow">{{ t("actionPanel") }}</p>
        <h2>{{ t("actionPanelHint") }}</h2>
      </div>
      <div class="status-chip" [class.warn]="!apiAvailable">
        {{ apiAvailable ? t("status") : t("apiOffline") }}
      </div>
    </div>

    <div class="controls">
      <label>
        <span>{{ t("selectBook") }}</span>
        <select
          [(ngModel)]="selectedBookId"
          (ngModelChange)="onBookSelectionChange($event)"
          [disabled]="!apiAvailable || !books.length"
        >
          <option *ngFor="let b of books" [value]="b.id">
            {{ b.id }} ‚Äî {{ b.title }}
          </option>
        </select>
      </label>
      <label>
        <span>{{ t("selectMember") }}</span>
        <select
          [(ngModel)]="selectedMemberId"
          (ngModelChange)="onMemberSelectionChange($event)"
          [disabled]="!apiAvailable || !members.length"
        >
          <option *ngFor="let m of members" [value]="m.id">
            {{ m.id }} ‚Äî {{ m.name }}
          </option>
        </select>
      </label>
      <div class="actions-container">
        <div class="actions">
          <button
            *ngIf="canBorrow()"
            (click)="borrow()"
            [disabled]="loading || !apiAvailable"
          >
            {{ t("borrow") }}
          </button>
          <button
            *ngIf="canReserve()"
            class="secondary"
            (click)="reserve()"
            [disabled]="loading || !apiAvailable"
          >
            {{ t("reserve") }}
          </button>
          <button
            *ngIf="canCancelReservation()"
            class="ghost"
            (click)="cancelReservation()"
            [disabled]="loading || !apiAvailable"
          >
            {{ t("cancelReservation") }}
          </button>
          <button
            *ngIf="canReturn()"
            class="ghost"
            (click)="returnBook()"
            [disabled]="loading || !apiAvailable"
          >
            {{ t("return") }}
          </button>
          <button
            *ngIf="canExtendLoan()"
            class="ghost"
            (click)="openExtensionModal()"
            [disabled]="loading || !apiAvailable"
          >
            {{ t("extendLoan") }}
          </button>
        </div>
      </div>
    </div>

    <div class="status-grid">
      <div class="status-card">
        <p class="muted">{{ t("status") }}</p>
        <div class="status-text">
          {{ loading ? t("loading") : lastMessage || t("statusIdle") }}
        </div>
      </div>
      <div class="status-card">
        <p class="muted">{{ t("bookStatus") }}</p>
        <div class="status-text">
          <ng-container *ngIf="activeBook; else noBook">
            {{ activeBook.title }} ¬∑ {{ bookStatusLabel(activeBook) }}
          </ng-container>
          <ng-template #noBook>{{ t("selectBook") }}</ng-template>
        </div>
      </div>
      <div class="status-card">
        <p class="muted">{{ t("memberStatus") }}</p>
        <div class="status-text">
          <ng-container *ngIf="activeMember; else noMember">
            {{ activeMember.name }}
          </ng-container>
          <ng-template #noMember>{{ t("selectMember") }}</ng-template>
        </div>
      </div>
    </div>
  </section>

  <section class="grid two-col">
    <div class="card">
      <div class="card__header">
        <div class="header-left">
          <h3>{{ t("booksTitle") }}</h3>
          <button
            class="secondary small-btn"
            (click)="openBookModal('create')"
            [disabled]="loading || !apiAvailable"
          >
            {{ t("add") }}
          </button>
        </div>
        <span class="badge">{{ books.length }}</span>
      </div>
      <ng-container *ngIf="books.length; else noBooks">
        <ul class="list">
          <li
            *ngFor="let b of books"
            [class.active]="b.id === selectedBookId"
            (click)="selectBook(b.id)"
          >
            <div class="line">
              <div>
                <div class="id">{{ b.id }}</div>
                <div class="title">{{ b.title }}</div>
              </div>
              <div class="chip-group">
                <span class="chip" [class.warn]="!!b.loanedTo">{{
                  bookStatusLabel(b)
                }}</span>
                <span class="chip outline" *ngIf="b.loanedTo"
                  >{{ t("holder") }}: {{ b.loanedTo }}</span
                >
                <span
                  class="chip due-date"
                  *ngIf="b.loanedTo && b.dueDate"
                  [class.overdue]="formatDueDate(b.dueDate).includes('‚ö†Ô∏è')"
                  >{{ formatDueDate(b.dueDate) }}</span
                >
                <button
                  class="icon-btn"
                  (click)="openBookModal('edit', b); $event.stopPropagation()"
                  [disabled]="loading || !apiAvailable"
                  title="{{ t('edit') }}"
                >
                  ‚úé
                </button>
                <button
                  class="icon-btn danger"
                  (click)="deleteBook(b.id); $event.stopPropagation()"
                  [disabled]="loading || !apiAvailable"
                  title="{{ t('delete') }}"
                >
                  ‚úï
                </button>
              </div>
            </div>
            <div class="muted row">
              <span>{{ t("queue") }}:</span>
              <div
                class="queue"
                *ngIf="b.reservationQueue.length; else noQueue"
              >
                <span class="queue-chip" *ngFor="let m of b.reservationQueue">{{
                  m
                }}</span>
              </div>
              <ng-template #noQueue>{{ t("queueEmpty") }}</ng-template>
            </div>
          </li>
        </ul>
      </ng-container>
      <ng-template #noBooks>
        <div class="empty">{{ t("booksEmpty") }}</div>
      </ng-template>
    </div>

    <div class="card">
      <div class="card__header">
        <div class="header-left">
          <h3>{{ t("membersTitle") }}</h3>
          <button
            class="secondary small-btn"
            (click)="openMemberModal('create')"
            [disabled]="loading || !apiAvailable"
          >
            {{ t("add") }}
          </button>
        </div>
        <span class="badge">{{ members.length }}</span>
      </div>
      <ng-container *ngIf="members.length; else noMembers">
        <ul class="list members">
          <li
            *ngFor="let m of members"
            [class.active]="m.id === selectedMemberId"
            (click)="selectMember(m.id)"
          >
            <div class="line">
              <div class="id">{{ m.id }}</div>
              <div class="title">{{ m.name }}</div>
              <div class="chip-group">
                <button
                  class="icon-btn"
                  (click)="openMemberModal('edit', m); $event.stopPropagation()"
                  [disabled]="loading || !apiAvailable"
                  title="{{ t('edit') }}"
                >
                  ‚úé
                </button>
                <button
                  class="icon-btn danger"
                  (click)="deleteMember(m.id); $event.stopPropagation()"
                  [disabled]="loading || !apiAvailable"
                  title="{{ t('delete') }}"
                >
                  ‚úï
                </button>
              </div>
            </div>
          </li>
        </ul>
      </ng-container>
      <ng-template #noMembers>
        <div class="empty">{{ t("membersEmpty") }}</div>
      </ng-template>
    </div>
  </section>

  <section class="card overdue-section">
    <div class="card__header">
      <div>
        <h2>‚ö†Ô∏è Overdue Books</h2>
      </div>
      <button
        class="secondary"
        (click)="loadOverdueBooks()"
        [disabled]="loading || !apiAvailable"
      >
        üîÑ Refresh Overdue
      </button>
    </div>
    <div class="card__body">
      <ng-container *ngIf="overdueBooks.length > 0; else noOverdue">
        <ul class="overdue-list">
          <li *ngFor="let book of overdueBooks" class="overdue-item">
            <div class="overdue-item__content">
              <strong class="overdue-item__title">{{ book.title }}</strong>
              <span class="overdue-details">
                Borrowed by:
                <span class="highlight">{{ book.loanedTo }}</span> | Due:
                <span class="highlight">{{ book.dueDate }}</span> | Days
                overdue:
                <span class="overdue-days">{{
                  calculateDaysOverdue(book.dueDate)
                }}</span>
              </span>
            </div>
          </li>
        </ul>
      </ng-container>
      <ng-template #noOverdue>
        <div class="success-message">‚úÖ No overdue books</div>
      </ng-template>
    </div>
  </section>

  <section class="card member-summary-section">
    <div class="card__header">
      <div>
        <h2>üë§ Member Summary</h2>
      </div>
    </div>
    <div class="card__body">
      <div class="member-selector">
        <label for="memberSummarySelect">Select a member:</label>
        <select
          id="memberSummarySelect"
          [(ngModel)]="selectedMemberId"
          (change)="selectedMemberId && loadMemberSummary(selectedMemberId)"
          [disabled]="loading || !apiAvailable"
        >
          <option [value]="null">-- Choose a member --</option>
          <option *ngFor="let m of members" [value]="m.id">
            {{ m.name }} ({{ m.id }})
          </option>
        </select>
      </div>

      <ng-container *ngIf="memberSummary">
        <div class="member-info">
          <div class="loans-section">
            <h4>üìö Current Loans ({{ memberSummary.loans.length }})</h4>
            <ng-container *ngIf="memberSummary.loans.length > 0; else noLoans">
              <ul class="summary-list">
                <li
                  *ngFor="let loan of memberSummary.loans"
                  class="summary-item"
                >
                  <span class="summary-item__title">{{ loan.title }}</span>
                  <span class="summary-item__details">
                    Book ID: <span class="highlight">{{ loan.bookId }}</span> |
                    Due: <span class="highlight">{{ loan.dueDate }}</span>
                  </span>
                </li>
              </ul>
            </ng-container>
            <ng-template #noLoans>
              <p class="no-data">No active loans</p>
            </ng-template>
          </div>

          <div class="reservations-section">
            <h4>
              üìå Active Reservations ({{ memberSummary.reservations.length }})
            </h4>
            <ng-container
              *ngIf="memberSummary.reservations.length > 0; else noReservations"
            >
              <ul class="summary-list">
                <li
                  *ngFor="let reservation of memberSummary.reservations"
                  class="summary-item"
                >
                  <span class="summary-item__title">{{
                    reservation.title
                  }}</span>
                  <span class="summary-item__details">
                    Book ID:
                    <span class="highlight">{{ reservation.bookId }}</span> |
                    Queue Position:
                    <span class="highlight">{{
                      reservation.position + 1
                    }}</span>
                  </span>
                </li>
              </ul>
            </ng-container>
            <ng-template #noReservations>
              <p class="no-data">No active reservations</p>
            </ng-template>
          </div>
        </div>
      </ng-container>

      <div *ngIf="!memberSummary && selectedMemberId" class="loading-message">
        Loading member summary...
      </div>

      <div *ngIf="!memberSummary && !selectedMemberId" class="hint-message">
        Select a member to view their loans and reservations
      </div>
    </div>
  </section>

  <div class="modal-backdrop" *ngIf="bookModalOpen">
    <div class="modal card">
      <div class="card__header">
        <h3>
          {{ bookModalMode === "edit" ? t("edit") : t("add") }}
          {{ t("booksTitle") }}
        </h3>
        <button
          class="icon-btn"
          (click)="closeBookModal()"
          title="{{ t('cancelAction') }}"
        >
          ‚úï
        </button>
      </div>

      <div class="error-banner" *ngIf="bookModalError">
        <span class="error-icon">‚ö†Ô∏è</span>
        <span class="error-message">{{
          formatErrorMessage(bookModalError)
        }}</span>
        <button
          class="error-close"
          (click)="dismissBookError()"
          title="Dismiss"
        >
          ‚úï
        </button>
      </div>

      <div class="form-grid">
        <label class="field">
          <span>{{ t("bookId") }}</span>
          <input
            #bookIdField
            [placeholder]="t('bookId')"
            [(ngModel)]="bookIdInput"
            [disabled]="bookModalMode === 'edit' || loading"
            [class.input-error]="bookModalError"
          />
        </label>
        <label class="field">
          <span>{{ t("bookTitle") }}</span>
          <input
            [placeholder]="t('bookTitle')"
            [(ngModel)]="bookTitleInput"
            [disabled]="loading"
          />
        </label>
      </div>
      <div class="actions split">
        <button
          (click)="submitBookModal()"
          [disabled]="
            loading ||
            !bookTitleInput ||
            (!bookIdInput && bookModalMode === 'create')
          "
        >
          {{ t("save") }}
        </button>
        <button class="secondary" (click)="closeBookModal()">
          {{ t("cancelAction") }}
        </button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="memberModalOpen">
    <div class="modal card">
      <div class="card__header">
        <h3>
          {{ memberModalMode === "edit" ? t("edit") : t("add") }}
          {{ t("membersTitle") }}
        </h3>
        <button
          class="icon-btn"
          (click)="closeMemberModal()"
          title="{{ t('cancelAction') }}"
        >
          ‚úï
        </button>
      </div>

      <div class="error-banner" *ngIf="memberModalError">
        <span class="error-icon">‚ö†Ô∏è</span>
        <span class="error-message">{{
          formatErrorMessage(memberModalError)
        }}</span>
        <button
          class="error-close"
          (click)="dismissMemberError()"
          title="Dismiss"
        >
          ‚úï
        </button>
      </div>

      <div class="form-grid">
        <label class="field">
          <span>{{ t("memberId") }}</span>
          <input
            #memberIdField
            [placeholder]="t('memberId')"
            [(ngModel)]="memberIdInput"
            [disabled]="memberModalMode === 'edit' || loading"
            [class.input-error]="memberModalError"
          />
        </label>
        <label class="field">
          <span>{{ t("memberName") }}</span>
          <input
            [placeholder]="t('memberName')"
            [(ngModel)]="memberNameInput"
            [disabled]="loading"
          />
        </label>
      </div>
      <div class="actions split">
        <button
          (click)="submitMemberModal()"
          [disabled]="
            loading ||
            !memberNameInput ||
            (!memberIdInput && memberModalMode === 'create')
          "
        >
          {{ t("save") }}
        </button>
        <button class="secondary" (click)="closeMemberModal()">
          {{ t("cancelAction") }}
        </button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="extensionModalOpen">
    <div class="modal card extension-modal">
      <div class="card__header">
        <h3>{{ t("extendLoan") }} for "{{ activeBook?.title }}"</h3>
        <button
          class="icon-btn"
          (click)="closeExtensionModal()"
          title="{{ t('cancelAction') }}"
        >
          ‚úï
        </button>
      </div>
      <div class="extension-content">
        <div class="date-info">
          <label class="field">
            <span class="muted">{{ t("currentDue") }}</span>
            <span class="date-value">{{
              currentDueDate ? formatDueDate(currentDueDate) : "N/A"
            }}</span>
          </label>
        </div>
        <label class="field">
          <span>{{ t("extendBy") }}</span>
          <div class="number-input-group">
            <input
              type="number"
              [(ngModel)]="extensionDays"
              [min]="MIN_EXTENSION_DAYS"
              [max]="MAX_EXTENSION_DAYS"
              step="1"
              [disabled]="loading"
            />
            <span class="unit">days</span>
          </div>
        </label>
        <div class="date-info">
          <label class="field">
            <span class="muted">{{ t("newDue") }}</span>
            <span class="date-value highlight">{{ newDueDate || "N/A" }}</span>
          </label>
        </div>
      </div>
      <div class="actions split">
        <button
          (click)="submitExtensionModal()"
          [disabled]="
            loading ||
            extensionDays < MIN_EXTENSION_DAYS ||
            extensionDays > MAX_EXTENSION_DAYS
          "
        >
          {{ t("extendLoan") }}
        </button>
        <button class="secondary" (click)="closeExtensionModal()">
          {{ t("cancelAction") }}
        </button>
      </div>
    </div>
  </div>
</main>
